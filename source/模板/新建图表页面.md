<% (async () => {
  // 【无星号版】使用立即执行函数包裹，完美避开语法解析 Bug
  
  // 1. 获取剪贴板
  const htmlContent = await tp.system.clipboard();
  
  // 2. 建议名称逻辑
  let suggestion = "new-chart";
  if (tp.file && tp.file.title) {
      // 这里的正则把空格替换为横杠，并转小写
      suggestion = tp.file.title.replace(/\s+/g, "-").toLowerCase();
  }
  
  // 3. 弹窗询问
  const folderName = await tp.system.prompt("请输入图表文件夹名称 (英文ID)", suggestion);
  
  if (folderName) {
      // ⚠️ 路径配置：根据你的目录结构，这里指向 source/charts/
      const targetFolder = `source/charts/${folderName}`;
      const targetFile = `${targetFolder}/index.html`;
      const vault = app.vault;
      
      // 检查剪贴板
      if (!htmlContent || htmlContent.trim() === "") {
          new Notice("❌ 剪贴板为空！请先复制 HTML 代码。");
      } else {
          // 检查文件是否存在
          const existingFile = vault.getAbstractFileByPath(targetFile);
          
          if (existingFile) {
              const confirm = await tp.system.prompt(`⚠️ ${folderName} 已存在，覆盖吗？(yes/no)`);
              if (confirm === 'yes') {
                  await vault.modify(existingFile, htmlContent);
                  new Notice(`✅ 已更新图表: ${folderName}`);
              }
          } else {
              try {
                  // 创建新文件
                  await tp.file.create_new(htmlContent, "index.html", false, targetFolder);
                  new Notice(`🎉 创建成功: ${folderName}`);
              } catch (e) {
                  new Notice(`❌ 创建失败: ${e.message}`);
                  console.error(e);
              }
          }
      }
  }
  
  // 4. 重要：返回空字符串，这样文档里就不会显示 undefined
  return "";
})() %>