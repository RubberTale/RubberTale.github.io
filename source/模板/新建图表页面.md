<% (async () => {
  // --- 终极修正版：强制创建 .html 后缀文件 ---
  
  // 1. 获取剪贴板
  const htmlContent = await tp.system.clipboard();
  
  // 2. 建议名称逻辑
  let suggestion = "new-chart";
  if (tp.file && tp.file.title) {
      suggestion = tp.file.title.replace(/\s+/g, "-").toLowerCase();
  }
  
  // 3. 弹窗询问
  const folderName = await tp.system.prompt("请输入图表文件夹名称 (英文ID)", suggestion);
  
  if (folderName) {
      // 定义路径
      const targetFolder = `source/charts/${folderName}`;
      const targetFilePath = `${targetFolder}/index.html`; // 完整路径
      
      const vault = app.vault;

      if (!htmlContent || htmlContent.trim() === "") {
          new Notice("❌ 剪贴板为空！请先复制 HTML 代码。");
      } else {
          
          // A. 先检查文件夹是否存在，不存在则手动创建
          // (app.vault.create 不会自动创建父文件夹，所以要手动来)
          if (!vault.getAbstractFileByPath(targetFolder)) {
              await vault.createFolder(targetFolder);
          }

          // B. 检查文件是否存在
          const existingFile = vault.getAbstractFileByPath(targetFilePath);
          
          if (existingFile) {
              const confirm = await tp.system.prompt(`⚠️ ${folderName} 已存在，覆盖吗？(yes/no)`);
              if (confirm === 'yes') {
                  await vault.modify(existingFile, htmlContent);
                  new Notice(`✅ 已更新图表: ${folderName}`);
              }
          } else {
              // C. 核心修改：使用底层 API 直接创建文件
              // 这会创建一个纯正的 .html 文件，没有 .md 后缀
              try {
                  await vault.create(targetFilePath, htmlContent);
                  new Notice(`🎉 创建成功: ${targetFilePath}`);
              } catch (e) {
                  new Notice(`❌ 创建失败: ${e.message}`);
                  console.error(e);
              }
          }
      }
  }
  
  return "";
})() %>